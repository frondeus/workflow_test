name: E2E Tests
on:
  issue_comment:
    types: [created, edited]
  push:
    branches: [ master ]
  workflow_dispatch:
jobs:
  build:
    name: Run tests
    runs-on: ubuntu-20.04
    if: ${{ github.event.push != null || (github.event.issue.pull_request && contains(github.event.comment.body, '/e2e')) }}
    steps:
      - if: contains(github.event.comment.body, '/e2e')
        name: Get App token
        id: app_token
        uses: machine-learning-apps/actions-app-token@master
        with:
          APP_PEM: ${{ secrets.FRONDEUS_GH_PEM }}
          APP_ID: ${{ secrets.FRONDEUS_GH_ID }}

      - if: contains(github.event.comment.body, '/e2e')
        name: Check comment sha
        id: sha
        uses: actions/github-script@v4
        with:
          result-encoding: string
          github-token: ${{ steps.app_token.outputs.app_token }}
          script: |
            const { owner, repo, number } = context.issue;
            github.reactions.createForIssueComment({
              owner,
              repo,
              comment_id: context.payload.comment.id,
              content: "+1"
            });
            const pr = await github.pulls.get({
              owner,
              repo,
              pull_number: number
            });
            return pr.data.head.sha;

      - if: contains(github.event.comment.body, '/e2e')
        uses: LouisBrunner/checks-action@v1.1.1
        id: check
        with:
          sha: ${{ steps.sha.outputs.result }}
          token: ${{ steps.app_token.outputs.app_token }}
          name: E2E tests
          details_url: https://github.com/${{github.repository}}/actions/runs/${{github.run_id}}
          status: in_progress

      - name: Checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 2

      - name: Run tests
        id: test
        run: |
          echo "Running tests ${{ env.GITHUB_SHA }}"
          sleep 6
          exit 1

      - if: contains(github.event.comment.body, '/e2e') && always()
        uses: LouisBrunner/checks-action@v1.1.1
        with:
          token: ${{ steps.app_token.outputs.app_token }}
          check_id: ${{ steps.check.outputs.check_id }}
          conclusion: ${{ job.status }}
          details_url: https://github.com/${{github.repository}}/actions/runs/${{github.run_id}}
